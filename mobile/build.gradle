apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'


android {
    compileSdk 34
    ndkVersion "25.2.9519653"

    lint {
        baseline = file("lint-baseline.xml") // æ·»åŠ è¿™ä¸€è¡Œ
    }
    defaultConfig {
        applicationId "net.activitywatch.android"
        minSdkVersion 24
        targetSdkVersion 34

        // Set in CI on tagged commit
        // FIXME: should be set before tagging, so that F-droid picks it up correctly
        //        https://gitlab.com/fdroid/fdroiddata/-/merge_requests/11786?commit_id=d2cedcbe3d26db59378d582a8cf952af16b6407f#note_1966750559
        versionName "0.12.1"

        // Set in CI by `bundle exec fastlane update_version`
        versionCode 34

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        // NOTE: This only works for API level 28 and above
        //testInstrumentationRunnerArguments useTestStorageService: 'true'

        // WARNING: Never commit this uncommented! (leads to huge APKs)
        //packagingOptions {
        //    doNotStrip '**/*.so'
        //}
        ndk {
            abiFilters "armeabi-v7a", "arm64-v8a" // æŒ‰éœ€é€‰æ‹©æ¶æ„
        }
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            ndk {
                debugSymbolLevel 'SYMBOL_TABLE'
            }
            // firebaseCrashlytics {
            //     nativeSymbolUploadEnabled true
            // }
        }
        debug {
            applicationIdSuffix ".debug"
            jniDebuggable true
            renderscriptDebuggable true
        }
    }
    compileOptions {
        sourceCompatibility = '1.8'
        targetCompatibility = '1.8'
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }
    namespace 'net.activitywatch.android'
    // Never got this to work...
    //if (project.hasProperty("doNotStrip")) {
    //    packagingOptions {
    //        doNotStrip '**/*.so'
    //    }
    //}

    // Creates a resource versionName with the full version
    // https://stackoverflow.com/a/36468650/965332
    applicationVariants.all { variant ->
        variant.resValue "string", "versionName", 'v' + variant.versionName
    }

    buildFeatures {
        viewBinding true
    }
}

// ======================
// ğŸš¨ æ–°å¢ï¼šSO æ–‡ä»¶å¼ºåˆ¶æ£€æŸ¥ - Modified definition
// ======================
// å®šä¹‰å¿…æ£€çš„ SO æ–‡ä»¶ï¼ˆæ¶æ„+è·¯å¾„ï¼‰
// æ³¨æ„ï¼šè¿™ä¸ªå®šä¹‰æ”¾åœ¨äº† android { ... } å—å¤–é¢ï¼Œè¿™æ˜¯æœ‰æ•ˆçš„ Gradle è¯­æ³•
def mandatorySoFiles = [
    "arm64-v8a/libaw_server.so",  // ä¸»æµ 64 ä½è®¾å¤‡ï¼ˆå¿…é€‰ï¼‰
    "armeabi-v7a/libaw_server.so" // å…¼å®¹ 32 ä½è®¾å¤‡ï¼ˆå¯é€‰ï¼Œå¯åˆ é™¤ï¼‰
]
task checkRequiredSoFiles { // Removed (type: Check), defaults to DefaultTask
    description = "ğŸ” æ£€æŸ¥å¿…éœ€çš„ SO æ–‡ä»¶æ˜¯å¦å­˜åœ¨"
    group = "Verification"

    doLast { // Added doLast block - å°†æ£€æŸ¥é€»è¾‘æ”¾åœ¨ doLast å—ä¸­
        mandatorySoFiles.each { soPath -> // è¿™ä¸ª mandatorySoFiles å˜é‡åœ¨è¿™é‡Œå¯ä»¥è®¿é—®åˆ°
            def soFile = file("src/main/jniLibs/$soPath")
            if (!soFile.exists()) {
                throw new GradleException(
                    "\nâŒ æ„å»ºå¤±è´¥ï¼šç¼ºå¤±å¿…éœ€çš„ SO æ–‡ä»¶\n" +
                    "æ–‡ä»¶è·¯å¾„ï¼š$soFile.absolutePath\n" +
                    "ä¿®å¤å»ºè®®ï¼š\n" +
                    "1. ç¡®ä¿ Rust æ¨¡å—ï¼ˆaw-server-rustï¼‰å·²æ­£ç¡®ç¼–è¯‘\n" +
                    "2. æ‰‹åŠ¨å°† SO æ–‡ä»¶å¤åˆ¶åˆ° jniLibs å¯¹åº”æ¶æ„ç›®å½•\n" +
                    "3. è¿è¡Œå‘½ä»¤ï¼š./gradlew cargoBuildï¼ˆå¦‚ä½¿ç”¨ Rust æ’ä»¶ï¼‰"
                )
            }
        }
    }
}
// ======================

// ======================
// å°†æ£€æŸ¥ç»‘å®šåˆ°æ‰€æœ‰æ„å»ºç±»å‹ï¼ˆdebug/releaseï¼‰
// ======================
/*
tasks.withType(com.android.build.gradle.tasks.PreBuildTask).all { // <--- Original line 108
Â  Â  dependsOn checkRequiredSoFiles
}
*/
// ======================
preBuild.dependsOn checkRequiredSoFiles

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"

    implementation 'androidx.appcompat:appcompat:1.5.1'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation 'androidx.cardview:cardview:1.0.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.recyclerview:recyclerview:1.2.1'
    implementation 'androidx.lifecycle:lifecycle-extensions:2.2.0'
    implementation 'androidx.annotation:annotation:1.5.0'

    implementation 'com.google.android.material:material:1.7.0'
    implementation 'com.jakewharton.threetenabp:threetenabp:1.4.3'
    implementation(platform("com.google.firebase:firebase-bom:32.3.1")) 
    implementation("com.google.firebase:firebase-analytics")
    implementation("com.google.firebase:firebase-crashlytics")
    implementation 'com.google.firebase:firebase-crashlytics-ndk:18.4.2'

    testImplementation "junit:junit:4.13.2"
    androidTestImplementation "androidx.test.ext:junit-ktx:$extJUnitVersion"
    androidTestImplementation "androidx.test:runner:$androidXTestVersion"
    androidTestImplementation "androidx.test:rules:$androidXTestVersion"
    androidTestImplementation "androidx.test.espresso:espresso-core:$espressoVersion"
    androidTestUtil "androidx.test.services:test-services:$servicesVersion"
    androidTestImplementation "androidx.test.espresso:espresso-web:$espressoVersion"
}

// Can be used to build with: ./gradlew cargoBuild
// NOTE: Doesn't work, chokes on building openssl-sys
apply plugin: 'org.mozilla.rust-android-gradle.rust-android'

cargo {
    module  = "../aw-server-rust"       // Or whatever directory contains your Cargo.toml
    libname = "aw_server"          // Or whatever matches Cargo.toml's [package] name.
    targets = ["arm", "arm64", "x86", "x86_64"]  // See bellow for a longer list of options
    profile = 'release'  // Selects the Cargo release profile (defaults to 'debug')
}

tasks.whenTaskAdded { task ->
    // TODO: Build aw-server lib here instead of in Makefile?
    // Doesn't work, chokes on building openssl-sys
    //if ((task.name == 'javaPreCompileDebug' || task.name == 'javaPreCompileRelease')) {
    //    task.dependsOn 'cargoBuild'
    //}

    // TODO: Build aw-webui here?
    //if (task.name.contains("assembleRelease")) {
    //    task.getDependsOn().add({
    //        // add your logic here
    //    })
    //}
}

apply plugin: "com.google.gms.google-services" // å¿…é¡»å­˜åœ¨ï¼Œä¸”åœ¨æœ€åä¸€è¡Œ
apply plugin: "com.google.firebase.crashlytics" // <--- **æ–°å¢è¿™ä¸€è¡Œ**